openapi: 3.0.3
info:
  title: Pet App API
  description: Pet registration and management API built with Kotlin, Spring WebFlux, and Clean Architecture.
  version: 1.0.0
  contact:
    name: Don Perry

servers:
  - url: http://localhost:8080
    description: Local development server

tags:
  - name: Pets
    description: Pet registration, listing, and management
  - name: Pet Detail
    description: Pet profile detail view
  - name: Avatar
    description: Pet avatar photo upload flow

security:
  - bearerAuth: []

paths:
  /api/pets:
    post:
      tags:
        - Pets
      summary: Register a new pet
      description: |
        Creates a new pet for the authenticated user.
        Maximum of 10 pets per user.
      operationId: registerPet
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterPetRequest'
      responses:
        '201':
          description: Pet registered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PetResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: VALIDATION_ERROR
                message: "Name must not be blank"
                timestamp: "2026-02-17T12:00:00Z"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          description: Pet limit exceeded (max 10 per user)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: PET_LIMIT_EXCEEDED
                message: "User has reached the maximum number of pets"
                timestamp: "2026-02-17T12:00:00Z"
        '500':
          $ref: '#/components/responses/InternalError'

    get:
      tags:
        - Pets
      summary: List all pets for the authenticated user
      description: Returns a summary list of all active (non-deleted) pets owned by the authenticated user.
      operationId: listPets
      responses:
        '200':
          description: List of pets
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PetListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/pets/{petId}:
    put:
      tags:
        - Pets
      summary: Update a pet
      description: |
        Full replacement of all mutable pet fields.
        Only the pet owner can update the pet.
        Fields `id`, `owner`, `registrationDate`, and `photoUrl` are preserved.
      operationId: updatePet
      parameters:
        - $ref: '#/components/parameters/petId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdatePetRequest'
      responses:
        '200':
          description: Pet updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PetResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: VALIDATION_ERROR
                message: "Name must not be blank"
                timestamp: "2026-02-17T12:00:00Z"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/PetNotFound'
        '500':
          $ref: '#/components/responses/InternalError'

    delete:
      tags:
        - Pets
      summary: Delete a pet (soft delete)
      description: |
        Soft-deletes a pet by setting `deletedAt` timestamp.
        Only the pet owner can delete the pet.
        Idempotent — deleting an already-deleted pet succeeds silently.
      operationId: deletePet
      parameters:
        - $ref: '#/components/parameters/petId'
      responses:
        '204':
          description: Pet deleted successfully (no content)
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/PetNotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/pets/{petId}/detail:
    get:
      tags:
        - Pet Detail
      summary: Get pet full profile
      description: |
        Returns the full detail view of a pet including all fields.
        Only the pet owner can view the detail.
        Soft-deleted pets are excluded (returns 404).
      operationId: getPetDetail
      parameters:
        - $ref: '#/components/parameters/petId'
      responses:
        '200':
          description: Pet detail retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PetDetailResponse'
        '401':
          description: Unauthorized — missing/invalid JWT or user is not the pet owner
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: UNAUTHORIZED
                message: "Not authorized to view this pet"
                timestamp: "2026-02-17T12:00:00Z"
        '404':
          $ref: '#/components/responses/PetNotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/pets/{petId}/avatar/presign:
    post:
      tags:
        - Avatar
      summary: Generate a presigned URL for avatar upload
      description: |
        Generates a presigned S3 URL for uploading a pet avatar photo.
        Only the pet owner can generate the URL.
        The presigned URL expires after 15 minutes.
        Only `image/jpeg` and `image/png` content types are allowed.
      operationId: generateAvatarPresignedUrl
      parameters:
        - $ref: '#/components/parameters/petId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GeneratePresignedUrlRequest'
      responses:
        '200':
          description: Presigned URL generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PresignedUrlResponse'
        '400':
          description: Validation error — invalid content type
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: VALIDATION_ERROR
                message: "Content type must be image/jpeg or image/png"
                timestamp: "2026-02-17T12:00:00Z"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/PetNotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/pets/{petId}/avatar/confirm:
    post:
      tags:
        - Avatar
      summary: Confirm avatar upload
      description: |
        Confirms that the avatar photo has been uploaded to S3 and updates the pet's `photoUrl`.
        Only the pet owner can confirm the upload.
        Verifies the photo exists in S3 before updating.
        Only `image/jpeg` and `image/png` content types are allowed.
      operationId: confirmAvatarUpload
      parameters:
        - $ref: '#/components/parameters/petId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConfirmAvatarUploadRequest'
      responses:
        '200':
          description: Avatar confirmed and pet updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PetResponse'
        '400':
          description: Validation error — invalid content type
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: VALIDATION_ERROR
                message: "Content type must be image/jpeg or image/png"
                timestamp: "2026-02-17T12:00:00Z"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: Pet or photo not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                petNotFound:
                  summary: Pet not found
                  value:
                    error: PET_NOT_FOUND
                    message: "Pet not found"
                    timestamp: "2026-02-17T12:00:00Z"
                photoNotFound:
                  summary: Photo not found in S3
                  value:
                    error: PHOTO_NOT_FOUND
                    message: "Photo not found in storage"
                    timestamp: "2026-02-17T12:00:00Z"
        '500':
          $ref: '#/components/responses/InternalError'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token with `user_id` claim in the payload

  parameters:
    petId:
      name: petId
      in: path
      required: true
      description: The pet's unique identifier
      schema:
        type: string

  schemas:
    RegisterPetRequest:
      type: object
      required:
        - name
        - species
        - age
      properties:
        name:
          type: string
          minLength: 1
          description: Pet name (must not be blank)
          example: Buddy
        species:
          type: string
          enum:
            - DOG
            - CAT
          description: Pet species (case-insensitive)
          example: DOG
        breed:
          type: string
          nullable: true
          minLength: 1
          description: Pet breed (optional, must not be blank if provided)
          example: Golden Retriever
        age:
          type: integer
          minimum: 0
          description: Pet age in years (must be >= 0)
          example: 3
        birthdate:
          type: string
          format: date
          nullable: true
          description: Pet birthdate in ISO format (optional, cannot be in the future)
          example: "2023-05-15"
        weight:
          type: number
          format: decimal
          nullable: true
          minimum: 0
          exclusiveMinimum: true
          description: Pet weight in kg (optional, must be > 0 if provided)
          example: 25.5
        nickname:
          type: string
          nullable: true
          minLength: 1
          description: Pet nickname (optional, must not be blank if provided)
          example: Bud

    UpdatePetRequest:
      type: object
      required:
        - name
        - species
        - age
      properties:
        name:
          type: string
          minLength: 1
          description: Pet name (must not be blank)
          example: Buddy
        species:
          type: string
          enum:
            - DOG
            - CAT
          description: Pet species (case-insensitive)
          example: DOG
        breed:
          type: string
          nullable: true
          minLength: 1
          description: Pet breed (optional, must not be blank if provided)
          example: Golden Retriever
        age:
          type: integer
          minimum: 0
          description: Pet age in years (must be >= 0)
          example: 4
        birthdate:
          type: string
          format: date
          nullable: true
          description: Pet birthdate in ISO format (optional, cannot be in the future)
          example: "2023-05-15"
        weight:
          type: number
          format: decimal
          nullable: true
          minimum: 0
          exclusiveMinimum: true
          description: Pet weight in kg (optional, must be > 0 if provided)
          example: 26.0
        nickname:
          type: string
          nullable: true
          minLength: 1
          description: Pet nickname (optional, must not be blank if provided)
          example: Bud

    GeneratePresignedUrlRequest:
      type: object
      required:
        - contentType
      properties:
        contentType:
          type: string
          enum:
            - image/jpeg
            - image/png
          description: MIME type of the image to upload
          example: image/jpeg

    ConfirmAvatarUploadRequest:
      type: object
      required:
        - contentType
      properties:
        contentType:
          type: string
          enum:
            - image/jpeg
            - image/png
          description: MIME type of the uploaded image
          example: image/jpeg

    PetResponse:
      type: object
      properties:
        id:
          type: string
          description: Unique pet identifier
          example: "550e8400-e29b-41d4-a716-446655440000"
        name:
          type: string
          example: Buddy
        species:
          type: string
          enum:
            - DOG
            - CAT
          example: DOG
        breed:
          type: string
          nullable: true
          example: Golden Retriever
        age:
          type: integer
          example: 3
        birthdate:
          type: string
          format: date
          nullable: true
          example: "2023-05-15"
        weight:
          type: number
          format: decimal
          nullable: true
          example: 25.5
        nickname:
          type: string
          nullable: true
          example: Bud
        owner:
          type: string
          description: Owner's user ID
          example: "auth0|123456789"
        registrationDate:
          type: string
          format: date
          example: "2026-01-10"
        photoUrl:
          type: string
          nullable: true
          description: URL to the pet's avatar photo
          example: "https://s3.amazonaws.com/bucket/pets/photo.jpg"

    PetListResponse:
      type: object
      properties:
        id:
          type: string
          example: "550e8400-e29b-41d4-a716-446655440000"
        name:
          type: string
          example: Buddy
        species:
          type: string
          enum:
            - DOG
            - CAT
          example: DOG
        breed:
          type: string
          nullable: true
          example: Golden Retriever
        photoUrl:
          type: string
          nullable: true
          example: "https://s3.amazonaws.com/bucket/pets/photo.jpg"

    PetDetailResponse:
      type: object
      properties:
        id:
          type: string
          example: "550e8400-e29b-41d4-a716-446655440000"
        name:
          type: string
          example: Buddy
        species:
          type: string
          enum:
            - DOG
            - CAT
          example: DOG
        breed:
          type: string
          nullable: true
          example: Golden Retriever
        age:
          type: integer
          description: Pet age in years
          example: 3
        birthdate:
          type: string
          format: date
          nullable: true
          example: "2023-05-15"
        weight:
          type: number
          format: decimal
          nullable: true
          example: 25.5
        nickname:
          type: string
          nullable: true
          example: Bud
        owner:
          type: string
          description: Owner's user ID
          example: "auth0|123456789"
        registrationDate:
          type: string
          format: date
          example: "2026-01-10"
        photoUrl:
          type: string
          nullable: true
          example: "https://s3.amazonaws.com/bucket/pets/photo.jpg"

    PresignedUrlResponse:
      type: object
      properties:
        uploadUrl:
          type: string
          description: Presigned S3 URL for uploading the avatar
          example: "https://s3.amazonaws.com/bucket/pets/photo.jpg?X-Amz-Algorithm=..."
        key:
          type: string
          description: S3 object key
          example: "pets/auth0|123456789/550e8400/avatar.jpg"
        expiresAt:
          type: string
          format: date-time
          description: Expiration timestamp of the presigned URL (15 minutes)
          example: "2026-02-17T12:15:00Z"

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Error code
          example: VALIDATION_ERROR
        message:
          type: string
          description: Human-readable error message
          example: "Name must not be blank"
        timestamp:
          type: string
          format: date-time
          description: ISO-8601 timestamp of the error
          example: "2026-02-17T12:00:00Z"

  responses:
    Unauthorized:
      description: Missing or invalid JWT token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: UNAUTHORIZED
            message: "Unauthorized"
            timestamp: "2026-02-17T12:00:00Z"

    PetNotFound:
      description: Pet not found or soft-deleted
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: PET_NOT_FOUND
            message: "Pet not found"
            timestamp: "2026-02-17T12:00:00Z"

    InternalError:
      description: Unexpected server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: INTERNAL_ERROR
            message: "An unexpected error occurred"
            timestamp: "2026-02-17T12:00:00Z"
